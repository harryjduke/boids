#include <stdbool.h>
#include <stdlib.h>

#include "raylib.h"
#include "raymath.h"

typedef struct {
    Vector2 position;
    Vector2 velocity;
} Boid;

#define BOID_LENGTH 10.f
#define BOID_WIDTH 5.f

void drawBoid(Boid boid) {
    Vector2 forwardVector = Vector2Normalize(boid.velocity);
    Vector2 vertex1 = Vector2Scale(forwardVector, BOID_LENGTH/2.f);
    Vector2 vertex2 = Vector2Add(Vector2Invert(vertex1), (Vector2){-forwardVector.y, forwardVector.x});
    Vector2 vertex3 = Vector2Invert(vertex2);

    // Transform vertices from local space to world space
    vertex1 = Vector2Add(vertex1, boid.position);
    vertex2 = Vector2Add(vertex2, boid.position);
    vertex3 = Vector2Add(vertex3, boid.position);

    DrawLineV(vertex1, vertex2, MAROON);
    DrawLineV(vertex2, vertex3, MAROON);
    DrawLineV(vertex3, vertex1, MAROON);
    DrawTriangle(vertex1, vertex2, vertex3, MAROON);
}

void spawnBoids(Boid *boidsArray, int numberOfBoids, Rectangle spawnBounds) {
    for (int i = 0; i < numberOfBoids; i++) {
        boidsArray[i] = (Boid) {
                (Vector2) {(float) GetRandomValue((int) spawnBounds.x, (int) (spawnBounds.x + spawnBounds.width)),
                           (float) GetRandomValue((int) spawnBounds.y, (int) (spawnBounds.y + spawnBounds.height))},
                (Vector2) {10.f, 5.f}};
    }
}

int main(int argc, char *argv[]) {
    const int screenWidth = 800;
    const int screenHeight = 450;

    const int numberOfBoids = 10;

    Boid boids[numberOfBoids];
    spawnBoids(boids, numberOfBoids, (Rectangle) {0.f, 0.f, (float) screenWidth, (float) screenHeight});

    InitWindow(screenWidth, screenHeight, "Boids");
    SetTargetFPS(60);

    while (!WindowShouldClose()) {
        // Update

        for (int i = 0; i < numberOfBoids; i++) {
            // Update position
            boids[i].position.x += boids[i].velocity.x * GetFrameTime();
            boids[i].position.y += boids[i].velocity.y * GetFrameTime();

            // Loop around screen edges
            if (boids[i].position.x < 0.f)
                boids[i].position.x = (float) screenWidth;
            if (boids[i].position.x > (float) screenWidth)
                boids[i].position.x = 0.f;
            if (boids[i].position.y < 0.f)
                boids[i].position.y = (float) screenHeight;
            if (boids[i].position.y > (float) screenHeight)
                boids[i].position.y = 0.f;
        }

        // Draw
        BeginDrawing();

        ClearBackground(RAYWHITE);

        for (int i = 0; i < numberOfBoids; i++) {
            // DrawCircleV(boids[i].position, 5.f, MAROON);
            drawBoid(boids[i]);
        }

        DrawText(TextFormat("FPS: %d", GetFPS()), 10, 10, 20, DARKGRAY);

        EndDrawing();
    }

    CloseWindow();
    return EXIT_SUCCESS;
}
